name: Deploy with CloudFormation

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1
  STACK_NAME: lambda-zapier-demo-stack
  LAMBDA_FUNCTION_NAME: sqs-unified-handler

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Package Lambda function
        run: |
          echo "Current directory: $(pwd)"
          ls -la
          
          # Install dependencies
          npm install --production
          
          # Create zip package (exclude unnecessary files)
          zip -r lambda-package.zip . \
            -x "*.git*" \
            -x "node_modules/.cache/*" \
            -x ".github/*" \
            -x "cloudformation/*" \
            -x "docs/*"
          
          echo "âœ… Lambda package created"
          ls -lh lambda-package.zip

      - name: Upload Lambda package to S3
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="lambda-zapier-demo-artifacts-${ACCOUNT_ID}"
          
          echo "Using S3 bucket: $BUCKET_NAME"
          
          # Create bucket if it doesn't exist
          if ! aws s3 ls "s3://${BUCKET_NAME}" 2>&1 > /dev/null; then
            echo "Creating S3 bucket..."
            aws s3 mb "s3://${BUCKET_NAME}" --region ${{ env.AWS_REGION }}
            
            # Enable versioning
            aws s3api put-bucket-versioning \
              --bucket "${BUCKET_NAME}" \
              --versioning-configuration Status=Enabled
          else
            echo "Bucket already exists"
          fi
          
          # Upload Lambda package
          aws s3 cp lambda-package.zip "s3://${BUCKET_NAME}/lambda-package.zip"
          
          echo "s3_bucket=$BUCKET_NAME" >> $GITHUB_ENV
          echo "âœ… Lambda package uploaded to S3"

      - name: Deploy CloudFormation Stack
        run: |
          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} 2>&1 | grep -q 'does not exist'; then
            echo "Creating new stack..."
            ACTION="create-stack"
          else
            echo "Updating existing stack..."
            ACTION="update-stack"
          fi
          
          # Deploy stack
          aws cloudformation $ACTION \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://cloudformation/template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            --parameters \
              ParameterKey=LambdaFunctionName,ParameterValue=${{ env.LAMBDA_FUNCTION_NAME }} \
            || true
          
          echo "âœ… Stack deployment initiated"

      - name: Wait for Stack to Complete
        run: |
          echo "Waiting for stack operation to complete..."
          
          # Wait for either create or update
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null || \
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true
          
          # Check final status
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text)
          
          echo "Final Stack Status: $STATUS"
          
          if [[ "$STATUS" == *"COMPLETE"* ]]; then
            echo "âœ… Stack operation completed successfully"
          elif [[ "$STATUS" == *"FAILED"* ]] || [[ "$STATUS" == *"ROLLBACK"* ]]; then
            echo "âŒ Stack operation failed with status: $STATUS"
            
            # Show recent stack events for debugging
            echo "Recent stack events:"
            aws cloudformation describe-stack-events \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }} \
              --max-items 10
            
            exit 1
          fi

      - name: Update Lambda Function Code
        run: |
          echo "Updating Lambda function code..."
          
          # Download from S3 and update
          aws s3 cp "s3://${{ env.s3_bucket }}/lambda-package.zip" /tmp/lambda-package.zip
          
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb:///tmp/lambda-package.zip \
            --region ${{ env.AWS_REGION }}
          
          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Lambda function code updated"

      - name: Get Stack Outputs
        id: outputs
        run: |
          echo "Fetching stack outputs..."
          
          # Get all outputs
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)
          
          PRODUCER_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ProducerUrl`].OutputValue' \
            --output text)
          
          CONSUMER_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ConsumerUrl`].OutputValue' \
            --output text)
          
          REPLAY_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ReplayUrl`].OutputValue' \
            --output text)
          
          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "producer_url=$PRODUCER_URL" >> $GITHUB_OUTPUT
          echo "consumer_url=$CONSUMER_URL" >> $GITHUB_OUTPUT
          echo "replay_url=$REPLAY_URL" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "ðŸŽ‰ DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo ""
          echo "ðŸ“ API Endpoints:"
          echo "   Producer: $PRODUCER_URL"
          echo "   Consumer: $CONSUMER_URL"
          echo "   Replay:   $REPLAY_URL"
          echo ""
          echo "ðŸ§ª Test Command:"
          echo "curl -X POST $PRODUCER_URL \\"
          echo "  -H 'Content-Type: application/json' \\"
          echo "  -d '{\"action\": \"get-pokemon\", \"pokemon\": \"pikachu\"}'"
          echo ""
          echo "=========================================="

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸš€ CloudFormation Deployment Successful!
          
          ## ðŸ“ API Endpoints
          
          - **Producer**: \`${{ steps.outputs.outputs.producer_url }}\`
          - **Consumer**: \`${{ steps.outputs.outputs.consumer_url }}\`
          - **Replay**: \`${{ steps.outputs.outputs.replay_url }}\`
          
          ## ðŸ§ª Test Commands
          
          \`\`\`bash
          # Queue a Pokemon request
          curl -X POST ${{ steps.outputs.outputs.producer_url }} \\
            -H 'Content-Type: application/json' \\
            -d '{"action": "get-pokemon", "pokemon": "pikachu"}'
          
          # Check execution status
          curl -X POST ${{ steps.outputs.outputs.producer_url }} \\
            -H 'Content-Type: application/json' \\
            -d '{"action": "get-status", "execution_id": "exec_xxx"}'
          
          # Manually process execution
          curl -X POST ${{ steps.outputs.outputs.consumer_url }} \\
            -H 'Content-Type: application/json' \\
            -d '{"execution_id": "exec_xxx"}'
          
          # Replay failed executions
          curl -X POST ${{ steps.outputs.outputs.replay_url }} \\
            -H 'Content-Type: application/json' \\
            -d '{}'
          \`\`\`
          
          ## ðŸ“Š CloudFormation Stack
          
          - **Stack Name**: \`${{ env.STACK_NAME }}\`
          - **Region**: \`${{ env.AWS_REGION }}\`
          - **Status**: âœ… Deployed
          
          ## ðŸ—‘ï¸ Easy Cleanup (Delete Everything)
          
          To delete all resources:
          \`\`\`bash
          aws cloudformation delete-stack \\
            --stack-name ${{ env.STACK_NAME }} \\
            --region ${{ env.AWS_REGION }}
          \`\`\`
          
          ## ðŸ” Monitor Resources
          
          - [CloudFormation Stack](https://console.aws.amazon.com/cloudformation/home?region=${{ env.AWS_REGION }}#/stacks)
          - [Lambda Function](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions/${{ env.LAMBDA_FUNCTION_NAME }})
          - [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group/$252Faws$252Flambda$252F${{ env.LAMBDA_FUNCTION_NAME }})
          - [API Gateway](https://console.aws.amazon.com/apigateway/home?region=${{ env.AWS_REGION }})
          - [SQS Queues](https://console.aws.amazon.com/sqs/v2/home?region=${{ env.AWS_REGION }})
          - [DynamoDB Tables](https://console.aws.amazon.com/dynamodbv2/home?region=${{ env.AWS_REGION }}#tables)
          EOF
